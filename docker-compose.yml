services:
  # -------------------------------------------------------
  # FASTAPI BACKEND (Main DFIR API)
  # -------------------------------------------------------
  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    ports:
      - "8080:8000"                     # Host:Container
    volumes:
      - ./data:/data                    # DFIR artifacts
      - ./static:/app/static            # UI assets
    env_file:
      - .env
    environment:
      ARTIFACT_DIR: /data/artifacts
      CHROMA_HOST: chroma
      CHROMA_PORT: "8000"

      # Demo tuning: stricter threshold => nonsense queries return []
      # If you want more results, raise this (e.g., 0.70).
      SEARCH_MAX_DISTANCE: "0.60"
    depends_on:
      - chroma
    restart: unless-stopped


  # -------------------------------------------------------
  # WORKER SERVICE (extraction + background jobs)
  # -------------------------------------------------------
  worker:
    build:
      context: .
      dockerfile: worker/Dockerfile
    volumes:
      - ./data:/data
    env_file:
      - .env
    environment:
      ARTIFACT_DIR: /data/artifacts

      # Worker posts back to the API internally
      API_URL: http://api:8000

      # Keep worker+api consistent when embedding/indexing
      CHROMA_HOST: chroma
      CHROMA_PORT: "8000"
      SEARCH_MAX_DISTANCE: "0.60"
    depends_on:
      - api
      - chroma
    restart: unless-stopped


  # -------------------------------------------------------
  # CHROMA VECTOR DATABASE
  # -------------------------------------------------------
  chroma:
    # RECOMMENDED: pin the version for stability
    # If you're currently on 0.5.3, keep 0.5.3.
    # Avoid :latest for demos.
    image: ghcr.io/chroma-core/chroma:0.5.3
    ports:
      - "8001:8000"                     # expose for debugging
    volumes:
      - ./chroma:/data
    restart: unless-stopped


  # -------------------------------------------------------
  # MINIO (Local S3-compatible object storage)
  # -------------------------------------------------------
  minio:
    image: minio/minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - ./minio:/data
    restart: unless-stopped
